name: Universal SBOM (Python + Node + Java)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sbom:
    runs-on: ubuntu-latest
    env:
      # Output directory for SBOMs
      BOM_DIR: /tmp/boms
      # Dependency-Track config from repository/organization secrets
      DTRACK_APPLICATION_URL: "https://dependencytrack-api.managedbyparabellyx.com/api/v1/bom"
      DTRACK_API_KEY: ${{ secrets.DTRACK_API_KEY }}
      DTRACK_PROJECT_UUID: "0760b41d-d109-41f0-856d-9350d7d05de6"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare workspace
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${BOM_DIR}"
          echo "Using BOM directory: ${BOM_DIR}"

      # ---------- Python (pip / poetry) ----------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Python | Generate CycloneDX BOM
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "requirements.txt" ] || ls requirements*.txt >/dev/null 2>&1 || [ -f "poetry.lock" ] || [ -f "pyproject.toml" ]; then
            echo "Python project detected. Installing cyclonedx-bom..."
            python -m pip install --upgrade pip
            python -m pip install cyclonedx-bom
            if [ -f "poetry.lock" ]; then
              echo "Generating Python BOM from poetry.lock..."
              python -m cyclonedx_py poetry --format xml --output-file "${BOM_DIR}/bom-python.xml"
            elif [ -f "requirements.txt" ] || ls requirements*.txt >/dev/null 2>&1; then
              REQ_FILE="$(ls requirements*.txt 2>/dev/null | head -n1)"
              [ -f "requirements.txt" ] && REQ_FILE="requirements.txt"
              echo "Generating Python BOM from ${REQ_FILE} ..."
              python -m cyclonedx_py requirements --input-file "${REQ_FILE}" --format xml --output-file "${BOM_DIR}/bom-python.xml"
            else
              echo "pyproject.toml without poetry.lock detected; trying environment scan (if any site-packages exist)."
              if python -c "import pkg_resources" 2>/dev/null; then
                python -m cyclonedx_py environment --format xml --output-file "${BOM_DIR}/bom-python.xml"
              else
                echo "No lock/requirements or importable environment. Skipping Python BOM."
              fi
            fi
          else
            echo "No Python manifest/lock found. Skipping Python BOM."
          fi

      # ---------- Node.js (npm / yarn / pnpm) ----------
      - name: Set up Node.js 20
        if: ${{ hashFiles('**/package-lock.json', '**/yarn.lock', '**/pnpm-lock.yaml') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Node | Generate CycloneDX BOM
        if: ${{ hashFiles('**/package.json') != '' }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "package.json" ]; then
            if [ -f "package-lock.json" ] || [ -f "yarn.lock" ] || [ -f "pnpm-lock.yaml" ]; then
              echo "Node project detected. Generating Node BOM..."
              npx --yes @cyclonedx/cyclonedx-npm --output-file "${BOM_DIR}/bom-node.xml" --output-format xml
            else
              echo "package.json found but no lockfile (package-lock.json/yarn.lock/pnpm-lock.yaml). Skipping Node BOM."
            fi
          else
            echo "No package.json found. Skipping Node BOM."
          fi

      # ---------- Java (Maven) ----------
      - name: Install Maven
        if: ${{ hashFiles('**/pom.xml') != '' }}
        shell: bash
        run: |
          sudo apt-get update -y
          sudo apt-get install -y maven

      - name: Java (Maven) | Generate CycloneDX BOM
        if: ${{ hashFiles('**/pom.xml') != '' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Generating Maven CycloneDX BOM..."
          mvn -q -B -DskipTests \
            org.cyclonedx:cyclonedx-maven-plugin:makeAggregateBom \
            -Dcyclonedx.skipAttach=true \
            -DoutputFormat=xml \
            -DoutputName=bom-java \
            -Dcyclonedx.outputDirectory="${BOM_DIR}"

      # ---------- Java (Gradle) ----------
      - name: Install Gradle
        if: ${{ hashFiles('**/build.gradle', '**/build.gradle.kts') != '' }}
        shell: bash
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gradle

      - name: Java (Gradle) | Generate CycloneDX BOM
        if: ${{ hashFiles('**/build.gradle', '**/build.gradle.kts') != '' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Creating CycloneDX Gradle init script..."
          cat > /tmp/cyclonedx-init.gradle <<'EOF'
          initscript {
            repositories { mavenCentral() }
            dependencies { classpath 'org.cyclonedx:cyclonedx-gradle-plugin:1.9.0' }
          }
          allprojects {
            apply plugin: org.cyclonedx.gradle.CycloneDxPlugin
          }
          EOF
          echo "Generating Gradle CycloneDX BOM..."
          gradle -I /tmp/cyclonedx-init.gradle \
            -Pcyclonedx.format=xml \
            -Pcyclonedx.outputName=bom-gradle \
            -Pcyclonedx.outputDirectory="${BOM_DIR}" \
            cyclonedxBom

      # ---------- Verify BOMs ----------
      - name: List generated BOMs
        shell: bash
        run: |
          set -euo pipefail
          echo "BOMs generated (if any):"
          ls -lh "${BOM_DIR}" || true

      # ---------- Upload all BOMs to Dependency-Track ----------
      - name: Upload CycloneDX BOMs to Dependency-Track
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=("${BOM_DIR}"/*.xml)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No BOM files to upload. Exiting gracefully."
            exit 0
          fi
          for f in "${files[@]}"; do
            echo "Uploading ${f} ..."
            curl -sS -f -X POST "${DTRACK_APPLICATION_URL}" \
              -H "X-Api-Key: ${DTRACK_API_KEY}" \
              -F "project=${DTRACK_PROJECT_UUID}" \
              -F "autoCreate=true" \
              -F "bom=@${f}"
            echo "OK: ${f}"
          done
