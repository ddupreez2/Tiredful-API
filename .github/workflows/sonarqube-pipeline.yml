# GitHub Actions workflow for SonarQube code quality scanning
# This workflow installs SonarScanner, analyzes your codebase, and uploads results to SonarQube.
#
# Required repository secrets (Settings → Secrets and variables → Actions → New repository secret):
#   - SONAR_APPLICATION_NAME : The SonarQube project key (e.g. my-app)
#   - SONAR_API_KEY          : SonarQube project token with analysis permissions
#
# Matches your Azure pipeline behavior:
# - Triggers only on pushes to main
# - Uses ubuntu-latest runner
# - Checks out full git history (fetch-depth: 0)
# - Installs SonarScanner CLI manually (no action change that could break auth)
# - Runs with sonar.python.version=3.12
#
# If you ever need PR analysis, add "pull_request:" to the on: block.

name: SonarQube Scan

on:
  push:
    branches:
      - master
  workflow_dispatch: {}

jobs:
  sonar-scan:
    runs-on: ubuntu-latest

    env:
      SONAR_APPLICATION_KEY: ${{ secrets.SONAR_APPLICATION_KEY }}
      SONAR_API_KEY: ${{ secrets.SONAR_API_KEY }}
      SONARQUBE_HOST_URL: https://sonarqube.managedbyparabellyx.com
      SONAR_SCANNER_VERSION: 6.2.1.4610

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download, Configure, and Run SonarScanner
        shell: bash
        run: |
          set -euo pipefail

          # Compose this path here (not in env:) to avoid expression parsing issues
          SONAR_SCANNER_HOME="$GITHUB_WORKSPACE/.sonar/sonar-scanner-${SONAR_SCANNER_VERSION}"

          mkdir -p "$GITHUB_WORKSPACE/.sonar"
          cd "$GITHUB_WORKSPACE/.sonar"

          curl --fail --location --silent --show-error --output sonar-scanner.zip \
            "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SONAR_SCANNER_VERSION}.zip"

          unzip -o sonar-scanner.zip
          export PATH="${SONAR_SCANNER_HOME}/bin:${PATH}"
          export SONAR_SCANNER_OPTS="-server"

          sonar-scanner --version

          # Return to project root for analysis
          cd "$GITHUB_WORKSPACE"

          sonar-scanner \
            -Dsonar.projectKey="${SONAR_APPLICATION_KEY}" \
            -Dsonar.sources=. \
            -Dsonar.host.url="${SONARQUBE_HOST_URL}" \
            -Dsonar.python.version=3.12 \
            -Dsonar.token="${SONAR_API_KEY}"
